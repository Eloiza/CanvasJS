<!DOCTYPE html>

<html>

<!-- Ao abrir o link, deve aparecer uma reta. Se o usuário pressionar o mouse sobre um dos cantos, aquele canto da reta será movido enquanto o outro canto da reta fica fixo. Se o mouse for pressionado no centro da reta, a reta toda deve ser movida.
 -->
<body>
	<h1>My First Canvas</h1>
	<canvas id="myCanvas" width="400" height="300" style="border:1px solid #000000;"></canvas>

	<script>

		//armazena dois vetores com as coordenadas de inicio e fim da linha 
		class line{
			constructor(p_ini, p_end, width){
				this.ini = p_ini;
				this.end = p_end;
				this.width = width;
			}
		}

		//armazena uma coordenada em um plano 2d
		class coord{
			constructor(x,y){
				this.x = x;
				this.y = y;
			}
		}

		//inicializando canvas do JS
		var canvas = document.getElementById("myCanvas");
		var ctx = canvas.getContext("2d");

		//configurando aparencia da reta
		ctx.lineWidth = 10;
		ctx.lineCap = 'round';
		ctx.strokeStyle = 'green';

		//Desenhando uma linha no canvas
		ctx.moveTo(50,50);
		ctx.lineTo(200,100);
		ctx.stroke();

		//instanciando coordenadas da linha
		let coord_ini = new coord(50, 50);
		let coord_end = new coord(200, 100);

		//instanciando objeto do tipo linha
		line_0 = new line(coord_ini, coord_end, 10);

		//inicializa coordenadas do mouse
		mouse_coord = new coord(0,0);
		mouse_start = new coord(0,0);

		selected = 0;

		//adicionando evento ao clicar na tela
		window.addEventListener('load', ()=>{
			canvas.addEventListener("mousedown", select);
			canvas.addEventListener("mouseup", unselect);
			canvas.addEventListener("mousemove", move_line);
		});

		//atualiza posicao do ponteiro do mouse
		function getPosition(event){
			mouse_coord.x = event.clientX - canvas.offsetLeft;
			mouse_coord.y = event.clientY - canvas.offsetTop;
		}

		//verifica se um elemento foi selecionado pelo clique
		function select(event){
			getPosition(event);
			if(ctx.isPointInStroke(mouse_coord.x, mouse_coord.y)){
				//se cor igual verde
				if(ctx.strokeStyle == '#008000'){
					ctx.strokeStyle = "blue";
				}
				else{
					ctx.strokeStyle = "green";
				}
				ctx.stroke();
				selected = 1;				
			}
		}

		function draw(){
			ctx.clearRect(0,0,canvas.width, canvas.height);
			ctx.beginPath(); //resseta o caminho salvo em ctx
			ctx.moveTo(line_0.ini.x,line_0.ini.y);
			ctx.lineTo(line_0.end.x,line_0.end.y);
			ctx.stroke();

		}

		function drag_line(event){
			if(selected){
				event.preventDefault();
				event.stopPropagation();
				
				getPosition(event);
				var dx = mouse_coord.x - mouse_start.x;
				var dy = mouse_coord.y - mouse_start.y;

				mouse_start.x = mouse_coord.x;
				mouse_start.y = mouse_coord.y;

				// alert(event.offsetX);	
				line_0.ini.x += dx;
				line_0.ini.y += dy;

				line_0.end.x += dx;
				line_0.end.y += dy;


				draw();

			}
		}

		function unselect(event){
			selected = 0;
		}

		//calcula a distancia entre o ponto a e b
		function distance(a, b){
			dist = Math.pow(b.x - a.x, 2) + Math.pow(b.y - a.y, 2);
			dist = Math.sqrt(dist);

			return dist;
		}
		function move_line(event){
			if(selected){
				getPosition(event);

				//checar qual ponto esta mais perto
				//distancia ponto inicial ao ponto do clique
				var dist_a = distance(line_0.ini, mouse_coord); 

				//distancia ponto inicial ao ponto do clique
				var dist_b = distance(line_0.end, mouse_coord);

				var m_point = new coord( (line_0.ini.x + line_0.end.x)/2, (line_0.ini.y + line_0.end.y)/2 )
				//distancia ponto inicial ao ponto do clique
				var dist_m = distance(m_point, mouse_coord);


				// //clique proximo ao inicio da reta
				// if(dist_a < dist_b & dist_a < dist_m){
				// 	line_0.ini.x = mouse_coord.x;
				// 	line_0.ini.y = mouse_coord.y;				
				// 	draw();
				// }

				// // clique proximo ao fim da reta
				// else if(dist_b < dist_a & dist_b < dist_m){
				// 	line_0.end.x = mouse_coord.x;
				// 	line_0.end.y = mouse_coord.y;				
				// 	draw();
				// }

				// clique no meio da reta
				// else if(dist_m < dist_a & dist_m < dist_b){
					var dx = mouse_coord.x - mouse_start.x;
					var dy = mouse_coord.y - mouse_start.y;


					var x_dist = m_point.x - line_0.ini.x;
					var y_dist = m_point.y - line_0.ini.y;


					var x_dist_end = line_0.end.x - m_point.x;
					var y_dist_end = line_0.end.y - m_point.y;

					//atualiza ponto medio da reta
					m_point.x += dx;
					m_point.y += dy;

					//atualiza posicao inicial do mouse
					mouse_start.x = mouse_coord.x;
					mouse_start.y = mouse_coord.y;

					line_0.ini.x = m_point.x - x_dist;
					line_0.ini.y = m_point.y - y_dist;

					line_0.end.x = m_point.x + x_dist_end;
					line_0.end.y = m_point.y + y_dist_end;


					// line_0.ini.x += dx;
					// line_0.ini.y += dy;

					// line_0.end.x += dx;
					// line_0.end.y += dy;

					draw();


				}

			}
	</script>

</body>
</html>